
// Map: Vesuvius_rev - by mrfin 2008

// revision of vesuvius by mrfin and firefly 2007

// last edit 05.09.08


game_manager
{
	spawn
	{
		// Game rules
		wm_axis_respawntime	20
		wm_allied_respawntime	20
		wm_number_of_objectives 8
		wm_set_round_timelimit	30

		// Objectives

		// Primary:
		// 1: Steal the urn from the ruins
		// 2: Escort the truck to the bridge gate
		// 3: Breach south valley gate
		// 4: Breach south valley gate2
		// 5: Construct the truck ramp
		// Secondary:
		// 6: construct ruins access rope
		// 7: Breach the north ruins gate
		// 8: Capture the church flag
		
		

		wm_objective_status 1 1 0 // <objective team status>
		wm_objective_status 1 0 0 // status: 0 = default
		wm_objective_status 2 1 0 //		 1 = succeeded
		wm_objective_status 2 0 0 //		 2 = failed
		wm_objective_status 3 1 0
		wm_objective_status 3 0 0
		wm_objective_status 4 1 0
		wm_objective_status 4 0 0
		wm_objective_status 5 1 0
		wm_objective_status 5 0 0
		wm_objective_status 6 1 0
		wm_objective_status 6 0 0
		wm_objective_status 7 1 0
		wm_objective_status 7 0 0
		wm_objective_status 8 1 0
		wm_objective_status 8 0 0
		

		wm_set_main_objective		1	0
		wm_set_main_objective		1	1

		wait 50

		///spawns

		
		setautospawn	"allies spawn"		1
		setautospawn	"Forward Flag"		0

		//// speakers//////

		setstate cp_speaker_allies invisible
		setstate cp_speaker_allies2 invisible
		setstate cp_speaker_axis invisible
		setstate cp_speaker_axis2 invisible
		setstate construction2_dummy invisible
		setstate bridge_clip invisible
		setstate forward_wobj2 invisible

			
		// Stopwatch mode defending team (0=Axis, 1=Allies)
		wm_set_defending_team	0

		// If the round timer expires, the Axis have won, so set the current winning team
		// Set the round winner:  0 == AXIS, 1 == ALLIED
		wm_setwinner 0

		wait 450

		wm_announce	"VESUVIUS_REV"

		wm_teamvoiceannounce 0 "axis_construct_cp"
		
		wm_teamvoiceannounce 0 "axis_defend_entrances"

		wm_teamvoiceannounce 1 "allies_entrances_dyn"
	
	
	}


	trigger obj_counter
	{
		accum 5 inc 1				// Increase game counter
		accum 5 abort_if_not_equal 3		// All objs destroyed ?
	
		wm_announce	"ALLIES HAVE ESCAPED WITH THE URN!"
	
		wait 8000
	
		accum 1 set 1				// All obs destroyed
			
		// Call function to check if the round has been won
		trigger game_manager checkgame
	}

	trigger checkgame
	{
		accum 1 abort_if_not_equal 1
	
		// Set the round winner:  0 == AXIS, 1 == ALLIED
		wm_setwinner 0

		// End the round
		wm_endround
		
	}
	
	trigger allies_win
	{
		wm_setwinner	1
		wm_announce "ALLIES ESCAPED WITH THE URN!!!"

		wm_objective_status 2 0 2
		wm_objective_status 2 1 1

		wait 5000
		wm_endround
	}
}

// **********************************************
// ****************** TRUCK STUFF ***************
// **********************************************

truck_smoke
{
	spawn
	{
		wait 300
		attachtotag truck tag_wfront
		setstate truck_smoke invisible
	}
}

// sound "thread"
truck_engine
{
	spawn
	{
		wait 200
		attachtotag truck tag_wfront

		trigger truck_engine sound_idle
	}

	trigger start
	{
		trigger truck_engine sound_start
		wait 950
		trigger truck_engine sound_move
	}

	trigger stop
	{
		trigger truck_engine sound_stop
		wait 950
		trigger truck_engine sound_idle
	}

	// ========================================
	// sound events
	trigger sound_idle
	{
		playsound sound/vehicles/truck/truck_idle.wav looping
	}

	trigger sound_start
	{
		stopsound
		playsound sound/vehicles/truck/truck_revup.wav volume 96
	}

	trigger sound_move
	{
		playsound sound/vehicles/truck/truck_move.wav looping
	}

	trigger sound_stop
	{
		stopsound
		playsound sound/vehicles/truck/truck_revdown.wav volume 96
	}

	trigger sound_death
	{
		stopsound
		playsound sound/vehicles/truck/truck_stop.wav volume 96
	}

	// ========================================
	// ========================================
}

truck_build
{
	spawn
	{
		wait 500

		attachtotag truck tag_wback
	}
}

truck_construct
{
	spawn
	{
		constructible_class 2
		constructible_health 1050
		constructible_constructxpbonus 10
		constructible_destructxpbonus 10
	}

	built final
	{
		alertentity truck

		wm_announce "The Truck has been repaired!"
	}
}

// digibob: ok, for once i'm gonna PLAN this one, so NOTHING WILL BREAK EVAR
// ============================================================================
// accum 0, gold bars collected
// accum 1
//  - bit 0: barrier 1 status 	( 0 = destroyed, 	1 = built 		)
//  - bit 1: barrier 2 status 	( 0 = destroyed, 	1 = built 		)
//  - bit 2: spline status 		( 0 = not moving, 	1 = moving 		)
//  - bit 3: stuck check flag 	( 0 = not stuck, 	1 = stuck 		)
//  - bit 4: script lockout 	( 0 = no lockout, 	1 = lockout		)
//  - bit 5: blank 				( 									)
//  - bit 6: temp register 		(XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX)
//  - bit 7: death status 		( 0 = alive, 		1 = dead		)
//  - bit 8: player check 		( 0 = players, 		1 = no players	)
//  - bit 9: visible state		( 0 = alive, 		1 = dead		)
// accum 2, blank
// accum 3, current movement loop position
// accum 4, stop counter
// accum 5, 
// accum 6, blank
// accum 7, blank
// ============================================================================
// spline points are tspln_X with X = 1 to 23
// ============================================================================
// wheel events:
//  - wheels_forward
//  - wheels_backward
//  - wheels_stop

truck
{
	spawn
	{
		faceangles 0 180 0 50
	}

	// ========================================
	// wheeeeeeeeeeeeeeels. eeels. ls.
	trigger wheels_forward
	{
		trigger truck_bwheel2 forward
		trigger truck_fwheel forward
	}

	trigger wheels_backward
	{
		trigger truck_bwheel2 backward
		trigger truck_fwheel backward
	}

	trigger wheels_stop
	{
		trigger truck_bwheel2 stop
		trigger truck_fwheel stop
	}

	// ========================================
	// ========================================

	trigger add_device
	{
		accum 0 inc 1

		trigger device_full show
		trigger device_trans hide
		trigger device secured

		accum 0 abort_if_less_than 1

		trigger device_full show
		trigger device_full hide

		//trigger self truck_escape_msg
		
		wm_teamvoiceannounce 1 "allies_objectivesecured"
		wm_announce "Allied team is escaping with the golden urn!"
		wm_teamvoiceannounce 1 "allies_truckstolen"
		

		wm_objective_status 1 0 2
		wm_objective_status 1 1 1

		//wm_set_main_objective 5 0
		//wm_set_main_objective 5 1

		setstate device_toi invisible
		setstate device_cm_marker invisible
	}



	// ========================================
	// movement

	trigger move_check
	{
		trigger truck stuck_check
		accum 1 abort_if_bitset 3

		trigger truck dispatch
	}

	trigger move
	{
		trigger truck move_check

		wait 500

		trigger truck move
	}

	// ========================================
	// ========================================


	trigger run_continue
	{
		trigger truck deathcheck
		trigger truck stopcheck
		trigger truck move
	}

	trigger run_1
	{
		accum 1 bitset 2
		followspline 0 tspln_1 125 wait length 304 wait roll 0 2 dampin
		accum 1 bitreset 2

		wm_teamvoiceannounce 0 "Axis_stopthatfuckingtruck"

		accum 3 set 1

		trigger truck run_continue
	}

	trigger run_2
	{
		accum 1 bitset 2
		followspline 0 tspln_2 125 wait length 304 wait roll 2 -1 dampout
		accum 1 bitreset 2

		trigger truck stuck_check_south_valley_gate

		accum 3 set 2
		trigger truck run_continue
	}

	trigger run_3
	{
		accum 1 bitset 2
		followspline 0 tspln_3 125 wait length 304 wait roll 1 -1 dampout
		accum 1 bitreset 2
		
		accum 3 set 3

		trigger truck run_continue
	}

	trigger run_4
	{
		accum 1 bitset 2
		followspline 0 tspln_4 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 4
		
		trigger truck run_continue
	}

	trigger run_5
	{
		accum 1 bitset 2
		followspline 0 tspln_5 125 wait length 304
		accum 1 bitreset 2

		//trigger forward_wobj2 default
		//setstate cp_axisdoor invisible
		accum 3 set 5
		trigger truck run_continue
	}

	trigger run_6
	{
		accum 1 bitset 2
		followspline 0 tspln_6 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 6
		trigger truck run_continue
	}

	trigger run_7
	{
		accum 1 bitset 2
		followspline 0 tspln_7 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 7
		trigger truck run_continue
	}

	trigger run_8
	{
		accum 1 bitset 2
		followspline 0 tspln_8 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 8
		trigger truck run_continue
	}

	trigger run_9
	{
		accum 1 bitset 2
		followspline 0 tspln_9 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 9
		trigger truck run_continue
	}

	trigger run_10
	{
		accum 1 bitset 2
		followspline 0 tspln_10 125 wait length 304 wait roll 0 -2 dampin
		accum 1 bitreset 2

		accum 3 set 10
		trigger truck run_continue
	}

	trigger run_11
	{
		accum 1 bitset 2
		followspline 0 tspln_11 125 wait length 304 wait roll -2 0
		accum 1 bitreset 2

		accum 3 set 11
		trigger truck run_continue
	}

	trigger run_12
	{
		accum 1 bitset 2
		followspline 0 tspln_12 125 wait length 304 wait roll -2 -1 dampin
		accum 1 bitreset 2

		accum 3 set 12
		trigger truck run_continue
	}

	trigger run_13
	{
		accum 1 bitset 2
		followspline 0 tspln_13 125 wait length 304 wait roll -3 0 dampout
		accum 1 bitreset 2

		accum 3 set 13
		trigger truck run_continue
	}

	trigger run_14
	{
		accum 1 bitset 2
		followspline 0 tspln_14 125 wait length 304 wait roll -3 +3 dampout
		accum 1 bitreset 2

		accum 3 set 14
		trigger truck run_continue
	}

	trigger run_15
	{
		accum 1 bitset 2
		followspline 0 tspln_15 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 15
		trigger truck run_continue
	}

	trigger run_16
	{
		accum 1 bitset 2
		followspline 0 tspln_16 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 16
		trigger truck run_continue
	}

	trigger run_17
	{
		accum 1 bitset 2
		followspline 0 tspln_17 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 17

		trigger truck run_continue
	}

	trigger run_18
	{
		accum 1 bitset 2
		followspline 0 tspln_18 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 18
		trigger truck run_continue
	}

	trigger run_19
	{
		accum 1 bitset 2
		followspline 0 tspln_19 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 19
		trigger truck run_continue
	}

	trigger run_20
	{
		accum 1 bitset 2
		followspline 0 tspln_20 125 wait length 304
		accum 1 bitreset 2

		//trigger forward_wobj2 default
		//trigger truck stuck_check_east_street_gate
		trigger forwardspawn allied_owned_endgame
		trigger forwardspawn kill
		
		wm_announce "Allied team OWNS the church forward spawn"
		accum 3 set 20
		trigger truck run_continue
	}

	trigger run_21
	{
		accum 1 bitset 2
		followspline 0 tspln_21 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 21
		trigger truck run_continue
	}

	trigger run_22
	{
		accum 1 bitset 2
		followspline 0 tspln_22 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 22
		trigger truck run_continue
	}

	trigger run_23
	{
		accum 1 bitset 2
		followspline 0 tspln_23 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 23
		trigger truck run_continue
	}

	trigger run_24
	{
		accum 1 bitset 2
		followspline 0 tspln_24 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 24
		trigger truck run_continue
	}

	trigger run_25
	{
		accum 1 bitset 2
		followspline 0 tspln_25 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 25
		trigger truck run_continue
	}

	trigger run_26
	{
		accum 1 bitset 2
		followspline 0 tspln_26 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 26
		trigger truck run_continue
	}

	trigger run_27
	{
		accum 1 bitset 2
		followspline 0 tspln_27 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 27
		trigger truck run_continue
	}

	trigger run_28
	{
		accum 1 bitset 2
		followspline 0 tspln_28 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 28
		trigger truck run_continue
	}
	
	trigger run_29
	{
		accum 1 bitset 2
		followspline 0 tspln_29 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 29
		trigger truck run_continue
	}

	trigger run_30
	{
		accum 1 bitset 2
		followspline 0 tspln_30 125 wait length 304
		accum 1 bitreset 2
		
	
		wm_objective_status 		8 0 2
		wm_objective_status 		8 1 1

		
		accum 3 set 30
		trigger truck run_continue
	}

	trigger run_31
	{
		
		// **************************
		//trigger east_gate remove
		// **************************
		accum 1 bitset 2
		followspline 0 tspln_31 125 wait length 304
		accum 1 bitreset 2

		
		// *----------------------------------- vo ------------------------------------------*
		//wm_teamvoiceannounce 0 "Axis_stopthatfuckingtruck"
		// *---------------------------------------------------------------------------------*

		accum 3 set 31
		trigger truck run_continue
	}

	trigger run_32
	{
		accum 1 bitset 2
		followspline 0 tspln_32 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 32
		trigger truck run_continue
	}

	trigger run_33
	{
		accum 1 bitset 2
		followspline 0 tspln_33 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 33
		trigger truck run_continue
	}

	trigger run_34
	{
		accum 1 bitset 2
		followspline 0 tspln_34 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 34
		trigger truck run_continue
	}

	trigger run_35
	{
		accum 1 bitset 2
		followspline 0 tspln_35 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 35
		trigger truck run_continue
	}
	trigger run_36
	{
		accum 1 bitset 2
		followspline 0 tspln_36 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 36
		trigger truck run_continue
	}

	trigger run_37
	{
		accum 1 bitset 2
		followspline 0 tspln_37 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 37
		trigger truck run_continue
	}

	trigger run_38
	{
		accum 1 bitset 2
		followspline 0 tspln_38 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 38
		trigger truck run_continue
	}
	trigger run_39
	{
		accum 1 bitset 2
		followspline 0 tspln_39 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 39
		trigger truck run_continue
	}
	trigger run_40
	{
		accum 1 bitset 2
		followspline 0 tspln_40 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 40
		trigger truck run_continue
	}

	trigger run_41
	{
		accum 1 bitset 2
		followspline 0 tspln_41 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 41
		trigger truck run_continue
	}

	trigger run_42
	{
		accum 1 bitset 2
		followspline 0 tspln_42 125 wait length 304
		accum 1 bitreset 2

		trigger truck stuck_check_ramp

		accum 3 set 42
		trigger truck run_continue
	}

	trigger run_43
	{
		accum 1 bitset 2
		followspline 0 tspln_43 125 wait length 304
		accum 1 bitreset 2

		setstate construction2_dummy default
		//setstate construction2 invisible
		
		setstate bridge_clip default

		accum 3 set 43

		trigger truck run_continue
	}

	trigger run_44
	{
		accum 1 bitset 2
		followspline 0 tspln_44 125 wait length 304
		accum 1 bitreset 2

		//trigger truck stuck_check_ramp

		accum 3 set 44
		trigger truck run_continue
	}

	trigger run_45
	{
		accum 1 bitset 2
		followspline 0 tspln_45 125 wait length 304
		accum 1 bitreset 2

		//trigger truck stuck_check_ramp

		accum 3 set 45
		trigger truck run_continue
	}

	trigger run_46
	{
		accum 1 bitset 2
		followspline 0 tspln_46 125 wait length 304
		accum 1 bitreset 2

		setstate construction2_dummy invisible
		//setstate construction2 default
		
		setstate bridge_clip invisible

		accum 3 set 46
		trigger truck run_continue
	}

	trigger run_47
	{
		accum 1 bitset 2
		followspline 0 tspln_47 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 47
		trigger truck run_continue
	}

	trigger run_48
	{
		accum 1 bitset 2
		followspline 0 tspln_48 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 48
		trigger truck run_continue
	}
	trigger run_49
	{
		accum 1 bitset 2
		followspline 0 tspln_49 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 49
		trigger truck run_continue
	}

	trigger run_50
	{
		accum 1 bitset 2
		followspline 0 tspln_50 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 50
		trigger truck run_continue
	}

	trigger run_51
	{
		accum 1 bitset 2
		followspline 0 tspln_51 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 51
		trigger truck run_continue
	}

	trigger run_52
	{
		accum 1 bitset 2
		followspline 0 tspln_52 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 52
		trigger truck run_continue
	}

	trigger run_53
	{
		accum 1 bitset 2
		followspline 0 tspln_53 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 53
		trigger truck run_continue
	}

	trigger run_54
	{
		accum 1 bitset 2
		followspline 0 tspln_54 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 54
		trigger truck run_continue
	}

	trigger run_55
	{
		accum 1 bitset 2
		followspline 0 tspln_55 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 55
		trigger truck run_continue
	}

	trigger run_56
	{
		accum 1 bitset 2
		followspline 0 tspln_56 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 56
		trigger truck run_continue
	}

	trigger run_57
	{
		accum 1 bitset 2
		followspline 0 tspln_57 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 57
		trigger truck run_continue
	}

	trigger run_58
	{
		accum 1 bitset 2
		followspline 0 tspln_58 125 wait length 304
		accum 1 bitreset 2
		
		trigger game_manager allies_win

		accum 3 set 58
		trigger truck run_continue
	}

	trigger run_59
	{
		accum 1 bitset 2
		followspline 0 tspln_59 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 59
		trigger truck run_continue
	}

	trigger run_60
	{
		accum 1 bitset 2
		followspline 0 tspln_60 125 wait length 304
		accum 1 bitreset 2

		accum 3 set 60
		trigger truck run_continue
	}

	
	
	
	trigger dispatch
	{
		accum 3 trigger_if_equal 0 	truck run_1
		accum 3 trigger_if_equal 1 	truck run_2
		accum 3 trigger_if_equal 2	truck run_3
		accum 3 trigger_if_equal 3 	truck run_4
		accum 3 trigger_if_equal 4 	truck run_5
		accum 3 trigger_if_equal 5 	truck run_6
		accum 3 trigger_if_equal 6 	truck run_7
		accum 3 trigger_if_equal 7 	truck run_8
		accum 3 trigger_if_equal 8 	truck run_9
		accum 3 trigger_if_equal 9 	truck run_10
		accum 3 trigger_if_equal 10	truck run_11
		accum 3 trigger_if_equal 11	truck run_12
		accum 3 trigger_if_equal 12	truck run_13
		accum 3 trigger_if_equal 13	truck run_14
		accum 3 trigger_if_equal 14	truck run_15
		accum 3 trigger_if_equal 15	truck run_16
		accum 3 trigger_if_equal 16	truck run_17
		accum 3 trigger_if_equal 17	truck run_18
		accum 3 trigger_if_equal 18	truck run_19
		accum 3 trigger_if_equal 19	truck run_20
		accum 3 trigger_if_equal 20	truck run_21
		accum 3 trigger_if_equal 21	truck run_22
		accum 3 trigger_if_equal 22	truck run_23
		accum 3 trigger_if_equal 23	truck run_24
		accum 3 trigger_if_equal 24	truck run_25
		accum 3 trigger_if_equal 25	truck run_26
		accum 3 trigger_if_equal 26	truck run_27
		accum 3 trigger_if_equal 27	truck run_28
		accum 3 trigger_if_equal 28	truck run_29
		accum 3 trigger_if_equal 29	truck run_30
		accum 3 trigger_if_equal 30	truck run_31
		accum 3 trigger_if_equal 31	truck run_32
		accum 3 trigger_if_equal 32	truck run_33
		accum 3 trigger_if_equal 33	truck run_34
		accum 3 trigger_if_equal 34	truck run_35
		accum 3 trigger_if_equal 35	truck run_36
		accum 3 trigger_if_equal 36	truck run_37
		accum 3 trigger_if_equal 37	truck run_38
		accum 3 trigger_if_equal 38	truck run_39
		accum 3 trigger_if_equal 39	truck run_40
		accum 3 trigger_if_equal 40	truck run_41
		accum 3 trigger_if_equal 41	truck run_42
		accum 3 trigger_if_equal 42	truck run_43
		accum 3 trigger_if_equal 43	truck run_44
		accum 3 trigger_if_equal 44	truck run_45
		accum 3 trigger_if_equal 45	truck run_46
		accum 3 trigger_if_equal 46	truck run_47
		accum 3 trigger_if_equal 47	truck run_48
		accum 3 trigger_if_equal 48	truck run_49
		accum 3 trigger_if_equal 49	truck run_50
		accum 3 trigger_if_equal 50	truck run_51
		accum 3 trigger_if_equal 51	truck run_52
		accum 3 trigger_if_equal 52	truck run_53
		accum 3 trigger_if_equal 53	truck run_54
		accum 3 trigger_if_equal 54	truck run_55
		accum 3 trigger_if_equal 55	truck run_56
		accum 3 trigger_if_equal 56	truck run_57
		accum 3 trigger_if_equal 57	truck run_58
		accum 3 trigger_if_equal 58	truck run_59
		accum 3 trigger_if_equal 59	truck run_60
		
				
	}

	// ========================================
	// barrier checking
	// digibob: since we cant return variables, just use bit 3 of accum 1 as a register... mmmm assembly......

	trigger stuck_check
	{
		accum 1 bitreset 3

		trigger truck stuck_check_device
		trigger truck stuck_check_south_valley_gate
		trigger truck stuck_check_east_street_gate
		//trigger truck stuck_check_barrier3
		trigger truck stuck_check_ramp
		trigger truck stuck_check_scriptlockout
		trigger truck stuck_check_finished
	}

	trigger stuck_check_finished
	{
		accum 3 abort_if_not_equal 59

		accum 1 bitset 3
	}

	trigger stuck_check_scriptlockout
	{
		accum 1 abort_if_not_bitset 4

		accum 1 bitset 3
	}

	trigger stuck_check_device
	{
		accum 3 abort_if_not_equal 0

		accum 0 abort_if_greater_than 0

		accum 1 bitset 3
	}

	
	trigger stuck_check_ramp			// truck ramp - construction2
	{
		accum 3 abort_if_not_equal 42		// location of the barrier
		accum 1 abort_if_bitset 0		// barrier status (bit not set = destroyed; bit set = built)

		accum 1 bitset 3				// we are stuck
	}

	trigger construction2_built
	{
		accum 1 bitset 0				// barrier 1 build
	}
	
	trigger construction2_destroyed
	{
		accum 1 bitreset 0			// barrier 1 destroyed
	}

	trigger stuck_check_south_valley_gate	// South valley gate
	{
		accum 3 abort_if_not_equal 2		// location of the barrier
		accum 2 abort_if_bitset 0		// barrier status (bit not set = destroyed; bit set = built)

		accum 1 bitset 3				// we are stuck
	}

	trigger south_valley_gate_destroyed
	{
		accum 2 bitset 0				// south valley gate destroyed
	}

	trigger stuck_check_east_street_gate	// north west barrier
	{
		accum 3 abort_if_not_equal 30		// location of the barrier
		accum 5 abort_if_equal 0		// barrier status (bit not set = destroyed; bit set = built)

		accum 1 bitset 3				// we are stuck
	}

	trigger east_street_gate_destroyed
	{
		accum 5 set 0				// north west barrier gate destroyed
	}

	trigger east_street_gate_constructed
	{
		accum 5 set 1
	}

// stop check

	trigger stopcheck_setup
	{
		accum 1 bitset 6				// stop if we're stuck/no-one's pushing :)

		accum 1 abort_if_bitset 8		// no one in the trigger, abort

		trigger truck stuck_check		// call the stop check function
		accum 1 abort_if_bitset 3		// we're stuck so break out

		accum 1 bitreset 6			// we're free to keep going
	}

	trigger stopcheck
	{
		trigger truck stopcheck_setup
		accum 1 abort_if_not_bitset 6

		trigger truck script_lockout

		// Any just stopped moving stuff goes here
		trigger truck_engine stop
		trigger truck 		wheels_stop
		// <<<<< stop animation goes here

		trigger truck script_lockout_stop
		resetscript
	}

	// ========================================
	// ========================================




	// ========================================
	// script lockouts

	trigger script_lockout
	{
		accum 1 bitset 4
	}

	trigger script_lockout_stop
	{
		accum 1 bitreset 4
	}

	// ========================================
	// ========================================


	// ========================================
	// enable/disable

	trigger truck_enable
	{
		trigger truck stuck_check
		accum 1 abort_if_bitset 3 	// stuck check

		accum 4 set 0				// reset stop counter
		accum 1 bitreset 8			// reset stop check

		accum 1 abort_if_bitset 2 	// already following spline
		accum 1 abort_if_bitset 4 	// script lockout

		accum 1 abort_if_bitset 7 	// death check

		// Any just started moving stuff goes here
		trigger truck_engine start
		trigger truck wheels_forward
		// <<<<< start animation goes here
		trigger truck move
	}

	trigger truck_disable
	{
		accum 4 inc 1				// up the stop counter
		accum 4 abort_if_less_than 2

		accum 1 bitset 8			// set stop check

		trigger truck deathcheck
	}

	// ========================================
	// ========================================

	// ========================================
	// death / rebirth

	rebirth
	{
		accum 1 bitreset 7 // we're alive again
		accum 1 bitreset 9 // we're visibly alive

		changemodel models/mapobjects/blitz_sd/blitzbody.md3

		setstate truck_smoke invisible

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_hq_truck_repaired_allies"

		wm_teamvoiceannounce 1 "allies_hq_truck_repaired"
		// *---------------------------------------------------------------------------------*

		trigger truck move
	}

	death
	{
		accum 1 bitset 7
	}

	trigger deathcheck
	{
		accum 1 abort_if_not_bitset 7	// are we dead?
		accum 1 abort_if_bitset 9		// are we not already visibly dead?
		accum 1 abort_if_bitset 2		// are we not following a spline?
		accum 1 abort_if_bitset 4		// are we not in a script lockout?

		accum 1 bitset 9				// we're now visibly dead

		wm_announce "The Truck has been damaged!"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_hq_truck_damaged"

		wm_teamvoiceannounce 1 "allies_hq_truck_damaged_axis"
		// *---------------------------------------------------------------------------------*

		setstate truck_smoke default
		kill truck_construct

		trigger truck_engine sound_death
		//trigger truck tracks_stop		// truck with tracks? i don't think so
		trigger truck wheels_stop
		// <<<< stop anim goes here

		changemodel models/mapobjects/blitz_sd/blitzbody_damaged.md3

		resetscript
	}

	// ========================================
	// ========================================




	// ========================================
	// barriers

	//trigger enable_stage1
	//{
	//	accum 1 bitreset 0
	//}

	//trigger disable_stage1
	//{
	//	accum 1 bitset 0
	//}

	//trigger enable_stage2
	//{
	//	accum 1 bitreset 1
	//}
	//
	//trigger disable_stage2
	//{
	//	accum 1 bitset 1
	//}

	// ========================================
	// ========================================
}

truck_bwheel2
{
	spawn
	{
		wait 500

		attachtotag truck tag_wback
	}

	trigger forward
	{
		setrotation 130 0 0
	}

	trigger backward
	{
		setrotation -130 0 0
	}

	trigger stop
	{
		stoprotation
	}
}

truck_fwheel
{
	spawn
	{
		wait 500

		attachtotag truck tag_wfront
	}

	trigger forward
	{
		setrotation 130 0 0
	}

	trigger backward
	{
		setrotation -130 0 0
	}

	trigger stop
	{
		stoprotation
	}
}

truck_trigger
{
	spawn
	{
		wait 500

		attachtotag truck tag_wback
	}
}

truck_disabler
{
	trigger run
	{
		trigger truck truck_disable
	}
}

truck_enabler
{
	trigger run
	{
		trigger truck truck_enable
	}
}

// *********************************************
// ****************** FLAG STUFF ***************
// *********************************************

device_holder
{
	death
	{
		trigger truck add_device
	}
}

// *********************************************
// ****************** DEVICE STUFF ***************
// *********************************************

device
{
	spawn
	{
		accum 0 set 0 // gold counter
	}

	trigger stolen
	{
		accum 0 inc 1
		accum 0 trigger_if_equal 1 gold_crate stolen1
		setstate device_cm_marker invisible
		//accum 0 trigger_if_equal 2 gold_crate stolen2
	}

	trigger secured
	{
		accum 0 trigger_if_equal 1 gold_crate secured1
		//accum 0 trigger_if_equal 2 gold_crate secured2
	}

	trigger returned
	{
		accum 0 inc -1
		accum 0 trigger_if_equal 0 gold_crate returned1
		setstate device_cm_marker default
		//accum 0 trigger_if_equal 1 gold_crate returned2
	}

}

device_full
{
	spawn
	{
		wait 500
		attachtotag truck tag_obj1
		faceangles 0 90 0 50

		setstate device_full invisible
	}

	trigger show
	{
		setstate device_full default
	}
}

device_trans
{
	spawn
	{
		wait 500
		attachtotag truck tag_obj1
		faceangles 0 90 0 50
	}

	trigger hide
	{
		setstate device_trans invisible
	}
}



// ================================================
// =========== FORWARD SPAWN POINT  ===============
// ================================================


forwardspawn
{
	spawn
	{
		accum 0 set 0	// Who has the flag: 0-Axis, 1-Allied
	}

	trigger axis_capture	// Flag has been touched by an Axis player
	{
		accum 0 abort_if_equal 0 // do Axis own flag?

		accum 0 set 0 // Axis own the pole
		wm_announce	"AXIS CAPTURE THE CHURCH!"
		wm_teamvoiceannounce 0 "axis_flaglost"
		wm_teamvoiceannounce 1 "allies_flaglost"


		wm_objective_status 		8 0 1
		wm_objective_status 		8 1 2

		alertentity forward_wobj
		//setstate forwardspawns default
		setautospawn	"allies spawn"		1
		setautospawn	"Forward Flag"		0
		
	}

	trigger allied_capture	// Flag has been touched by an allied player
	{
		accum 0 abort_if_equal 1 // do Allies own flag?

		accum 0 set 1 // Allied own the flag
		wm_announce	"ALLIES CAPTURE THE CHURCH!"
		wm_teamvoiceannounce 0 "axis_flagcaptured"
		wm_teamvoiceannounce 1 "allies_flagcaptured"
		
		wm_objective_status 		8 0 2
		wm_objective_status 		8 1 1

		alertentity forward_wobj

		setautospawn	"Forward Flag"		1
		setautospawn	"castle spawn"		0
		
	}

	trigger axis_owned
	{
		accum 0 abort_if_equal 0 // do Axis own flag?

		accum 0 set 0 // Axis own the pole
		wm_announce	"Axis gained spawn positions at the church!"


		
		//wm_objective_status 		8 0 1
		//wm_objective_status 		8 1 2

		alertentity forward_wobj						// Toggle CM flag from allies to axis
		alertentity axis_forwardspawns					// Toggle spawnpoints from allies to axis

		setautospawn	"allies spawn"		1
		setautospawn	"Forward Flag"		0
	
	}

	trigger allied_owned
	{
		accum 0 abort_if_equal 1 // do Allies own flag?

		accum 0 set 1 // Allied own the flag
		wm_announce	"Allies gained spawn positions at the church!"

		
		
		//wm_objective_status 		8 0 2
		//wm_objective_status 		8 1 1

		alertentity forward_wobj						// Toggle CM flag from axis to allies
		alertentity allied_forwardspawns					// Toggle spawnpoints from axis to allies
		
		setautospawn	"Forward Flag"		1
		setautospawn	"castle spawn"		0	
	}


	trigger allied_owned_endgame
	{

		wm_announce	"Allies gained spawn positions at the church!"

		
		accum 0 abort_if_equal 1 // Do Allied own the flag?

		//alertentity old_city_wobj
		//alertentity forwardspawns
	
		
		wm_objective_status 		8 0 2
		wm_objective_status 		8 1 1

		
		alertentity forward_wobj				// Toggle CM flag from axis to allies
		alertentity forwardspawns				// Toggle spawnpoints from axis to allies
		setstate forwardspawn invisible
		setstate axis_forwardspawns invisible
		setstate flag_clip1 invisible
		
		

		setautospawn	"Forward Flag"		1
		setautospawn	"castle spawn"		0	
	}

		trigger kill
	{
		remove
	}

}

// ================================================
// ============ NEUTRAL COMMAND POST ==============
// ================================================

allied_compost_built
{
	spawn
	{
		wait 400
		trigger allied_compost_built setup

		constructible_class 2
	}

	trigger setup
	{
		setchargetimefactor 1 soldier 1
		setchargetimefactor 1 lieutenant 1
		setchargetimefactor 1 medic 1
		setchargetimefactor 1 engineer 1
		setchargetimefactor 1 covertops 1
		sethqstatus 1 0
	}

	buildstart final
	{
		setstate allied_compost_built_model underconstruction
		setstate neutral_compost_closed_clip invisible
		setstate neutral_compost_closed_model invisible
	}

	built final
	{
		setstate allied_compost_built_model default
		setstate neutral_compost_closed_clip invisible
		setstate neutral_compost_closed_model invisible

		trigger allied_compost_built_model enable_allied_features

		setstate cp_speaker_allies default
		setstate cp_speaker_allies2 default

		//wm_objective_status	5 1 1
		//wm_objective_status	5 0 2
	}

	decayed final
	{
		setstate allied_compost_built_model invisible
		setstate neutral_compost_closed_clip default
		setstate neutral_compost_closed_model default
	}

	death
	{
		setstate allied_compost_built_model invisible
		setstate neutral_compost_closed_clip default
		setstate neutral_compost_closed_model default

		trigger allied_compost_built_model disable_allied_features

		setstate cp_speaker_allies invisible
		setstate cp_speaker_allies2 invisible
	}
}

allied_compost_built_model
{
	spawn
	{
		wait 400
		setstate allied_compost_built_model invisible
	}

	trigger enable_allied_features
	{
		setchargetimefactor 1 soldier 0.75
		setchargetimefactor 1 lieutenant 0.75
		setchargetimefactor 1 medic 0.75
		setchargetimefactor 1 engineer 0.75
		setchargetimefactor 1 covertops 0.75
		sethqstatus 1 1

		wm_announce	"Allied Command Post constructed. Charge speed increased!"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_hq_compost_constructed_allies"

		wm_teamvoiceannounce 1 "allies_hq_compost_constructed"
		// *---------------------------------------------------------------------------------*
		
	}

	trigger disable_allied_features
	{
		setchargetimefactor 1 soldier 1
		setchargetimefactor 1 lieutenant 1
		setchargetimefactor 1 medic 1
		setchargetimefactor 1 engineer 1
		setchargetimefactor 1 covertops 1
		sethqstatus 1 0

		wm_announce	"Axis team has destroyed the Allied Command Post!"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_hq_compost_construct"

		wm_teamvoiceannounce 1 "allies_hq_compost_damaged"

		// *---------------------------------------------------------------------------------*
		
	}
}

axis_compost_built
{
	spawn
	{
		wait 400
		trigger axis_compost_built setup

		constructible_class 2
	}

	trigger setup
	{
		setchargetimefactor 0 soldier 1
		setchargetimefactor 0 lieutenant 1
		setchargetimefactor 0 medic 1
		setchargetimefactor 0 engineer 1
		setchargetimefactor 0 covertops 1
		sethqstatus 0 0
	}

	buildstart final
	{
		setstate axis_compost_built_model underconstruction
		setstate neutral_compost_closed_clip invisible
		setstate neutral_compost_closed_model invisible
	}

	built final
	{
		setstate axis_compost_built_model default
		setstate neutral_compost_closed_clip invisible
		setstate neutral_compost_closed_model invisible

		trigger axis_compost_built_model enable_axis_features

		setstate cp_speaker_axis default
		setstate cp_speaker_axis2 default

		//wm_objective_status	5 1 2
		//wm_objective_status	5 0 1
	}

	decayed final
	{
		setstate axis_compost_built_model invisible
		setstate neutral_compost_closed_clip default
		setstate neutral_compost_closed_model default
	}

	death
	{
		setstate axis_compost_built_model invisible
		setstate neutral_compost_closed_clip default
		setstate neutral_compost_closed_model default

		trigger axis_compost_built_model disable_axis_features

		setstate cp_speaker_axis invisible
		setstate cp_speaker_axis2 invisible
	}
}

axis_compost_built_model
{
	spawn
	{
		wait 400
		setstate axis_compost_built_model invisible
	}

	trigger enable_axis_features
	{
		setchargetimefactor 0 soldier 0.75
		setchargetimefactor 0 lieutenant 0.75
		setchargetimefactor 0 medic 0.75
		setchargetimefactor 0 engineer 0.75
		setchargetimefactor 0 covertops 0.75
		sethqstatus 0 1

		wm_announce	"Axis Command Post constructed. Charge speed increased!"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_hq_compost_constructed"

		wm_teamvoiceannounce 1 "allies_hq_compost_constructed_axis"

		
		// *---------------------------------------------------------------------------------*
	}

	trigger disable_axis_features
	{
		setchargetimefactor 0 soldier 1
		setchargetimefactor 0 lieutenant 1
		setchargetimefactor 0 medic 1
		setchargetimefactor 0 engineer 1
		setchargetimefactor 0 covertops 1
		sethqstatus 0 0

		wm_announce	"Allied team has destroyed the Axis Command Post!"

		// *----------------------------------- vo ------------------------------------------*
		

		wm_teamvoiceannounce 0 "axis_hq_compost_damaged"

		wm_teamvoiceannounce 1 "allies_hq_compost_construct"
		// *---------------------------------------------------------------------------------*
	}
}

//=====================================================================================
//=============================== construct - ruins access rope ====================================
//========================================================================================

construction
{
	spawn
	{
		wait 400
		trigger construction setup

		constructible_class 3
	}

	trigger setup
	{
		setstate construction_materials default
		setstate construction_materials_clip default
		setstate construction_flag default


		setstate construction invisible
	}

	buildstart final
	{
		setstate construction_materials default
		setstate construction_materials_clip default
		setstate construction_flag default


		setstate construction underconstruction
	}

	built final
	{
		setstate construction_materials invisible
		setstate construction_materials_clip invisible
		setstate construction_flag invisible

		setstate construction default

		wm_announce "Allied team has constructed the ruins access rope"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_ropeconstructed"

		wm_teamvoiceannounce 1 "allies_ropeconstructed"
		// *---------------------------------------------------------------------------------*

		wm_objective_status	6 1 1
		wm_objective_status	6 0 2

	}
	decayed final
	{
		setstate construction_materials default
		setstate construction_materials_clip default
		setstate construction_flag default


		setstate construction invisible
	}

	death
	{
		setstate construction_materials default
		setstate construction_materials_clip default
		setstate construction_flag default

		setstate construction invisible

		wm_announce "ruins access rope destroyed"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_ropedestroyed"

		wm_teamvoiceannounce 1 "allies_ropedestroyed"
		// *---------------------------------------------------------------------------------*

		wm_objective_status	6 1 2
		wm_objective_status	6 0 1

	}
	
}

//=====================================================================================
//=============================== construct2 - the truck ramp ====================================
//========================================================================================

construction2
{
	spawn
	{
		wait 400
		trigger construction2 setup

		constructible_class 3
	}

	trigger setup
	{
		setstate construction2_materials default
		setstate construction2_materials_clip default
		setstate construction2_flag default


		setstate construction2 invisible
	}

	buildstart final
	{
		setstate construction2_materials default
		setstate construction2_materials_clip default
		setstate construction2_flag default


		setstate construction2 underconstruction
	}

	built final
	{
		setstate construction2_materials invisible
		setstate construction2_materials_clip invisible
		setstate construction2_flag invisible
		
		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_truckrampconstructed"

		wm_teamvoiceannounce 1 "allies_truckrampconstructed"
		// *---------------------------------------------------------------------------------*

		setstate construction2 default

		trigger truck construction2_built

		wm_objective_status	5 1 1
		wm_objective_status	5 0 2

	}
	decayed final
	{
		setstate construction2_materials default
		setstate construction2_materials_clip default
		setstate construction2_flag default


		setstate construction2 invisible
	}

	death
	{
		setstate construction2_materials default
		setstate construction2_materials_clip default
		setstate construction2_flag default

		setstate construction2 invisible

		trigger truck construction2_destroyed

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_truckrampdestroyed"

		wm_teamvoiceannounce 1 "allies_truckrampdestroyed"
		// *---------------------------------------------------------------------------------*

		wm_objective_status	5 1 2
		wm_objective_status	5 0 1

	}
	
}

//==================================================================
//================    Destructibles      ===========================
//==================================================================

//========================South Valley gate ======================

south_valley_gate

{
	spawn
	{
	wait 200
	constructible_class 3
	}
	death
	{
	 
	trigger truck south_valley_gate_destroyed
	kill axis_td_south_gate
	kill axis_td_south_gate2
	setstate gate1_clip invisible

	alertentity sg_effect
	
	wm_announce "Allied team has breached the south valley gate"

		// *----------------------------------- vo ------------------------------------------*
		wm_teamvoiceannounce 0 "axis_southgate1"

		wm_teamvoiceannounce 1 "allies_southgate1"

		wm_teamvoiceannounce 1 "allies_get_gold"

		wm_teamvoiceannounce 0 "axis_defend_gold"

		wm_teamvoiceannounce 1 "allies_hq_compost_construct"
		// *---------------------------------------------------------------------------------*	

	wm_objective_status	3 1 1
	wm_objective_status	3 0 2
	}
}

//====================== north ruins gate ============================

north_ruins_gate

{
	spawn
	{
	wait 200
	constructible_class 3
	}
	death
	{
	
	kill north_ruins_teamdoor
	alertentity north_ruins_gate_effect
	
	
	wm_announce "Allied team has breached the north ruins gate"
	// *----------------------------------- vo ------------------------------------------*
	wm_teamvoiceannounce 0 "axis_northgate"

	wm_teamvoiceannounce 1 "allies_northgate"
	// *---------------------------------------------------------------------------------*	


	wm_objective_status	7 1 1
	wm_objective_status	7 0 2
	}
}

 
/////////////////////////// south_valley_gate2 ////////////////////////

south_valley_gate2

{
	spawn
	{
	wait 200
	constructible_class 3
	}
	death
	{
	
	kill south_valley_teamdoor2
	setstate gate2_clip invisible
	//alertentity south_valley_gate2_effect
	
	
	wm_announce "Allied team has breached the lower south gate"
		

	// *----------------------------------- vo ------------------------------------------*
	wm_teamvoiceannounce 0 "axis_southgate2"

	wm_teamvoiceannounce 1 "allies_southgate2"

	wm_teamvoiceannounce 1 "allies_get_gold"

	wm_teamvoiceannounce 0 "axis_defend_gold"

	wm_teamvoiceannounce 1 "allies_hq_compost_construct"
	// *---------------------------------------------------------------------------------*	


	wm_objective_status	4 1 1
	wm_objective_status	4 0 2
	}
}



//========================= eruption sounds ===========================

timer_handler 
{ 
   trigger timer_event 
   { 
	alertentity eruption // rumble starton
	wait 2000 
     
	togglespeaker quake1 // church
	togglespeaker quake2 // eruption sound
	togglespeaker quake3 // church outside
		
	wait 19000

	alertentity eruption // rumble startoff
	
	
	
      //alertentity timer_relay // stop it 
   } 
} 












